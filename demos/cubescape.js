!function(e,t){if("object"==typeof exports&&"object"==typeof module)module.exports=t(require("gloperate"));else if("function"==typeof define&&define.amd)define(["gloperate"],t);else{var n="object"==typeof exports?t(require("gloperate")):t(e.gloperate);for(var i in n)("object"==typeof exports?exports:e)[i]=n[i]}}(self,(function(e){return(()=>{var t={430:function(e,t,n){"use strict";var i=this&&this.__decorate||function(e,t,n,i){var r,a=arguments.length,o=a<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,n):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,n,i);else for(var s=e.length-1;s>=0;s--)(r=e[s])&&(o=(a<3?r(o):a>3?r(t,n,o):r(t,n))||o);return a>3&&o&&Object.defineProperty(t,n,o),o};Object.defineProperty(t,"__esModule",{value:!0}),t.CubeGeometry=void 0;const r=n(160),a=n(160);class o extends a.Geometry{constructor(e,t){super(e,t),this._count=1,t=void 0!==t&&""!==t?t:this.constructor.name;const n=new a.Buffer(e,`${t}VBO`);this._buffers.push(n);const i=new a.Buffer(e,`${t}InstancesVBO`);this._buffers.push(i);const r=new a.Buffer(e,`${t}IndicesVBO`);this._buffers.push(r)}bindBuffers(){const e=this.context.gl2facade;this._buffers[0].attribEnable(this._vertexLocation,3,this.context.gl.FLOAT,!1,0,0,!0,!1),e.vertexAttribDivisor(this._vertexLocation,0),this._buffers[1].attribEnable(this._instanceLocation,3,this.context.gl.UNSIGNED_BYTE,!1,0,0,!0,!1),e.vertexAttribDivisor(this._instanceLocation,1),this._buffers[2].bind()}unbindBuffers(){this._buffers[0].attribDisable(this._vertexLocation,!0,!0),this._buffers[1].attribDisable(this._instanceLocation,!0,!0),this._buffers[2].unbind()}initialize(e=0,t=1){this._vertexLocation=e,this._instanceLocation=t;const n=this.context.gl,i=super.initialize([n.ARRAY_BUFFER,n.ARRAY_BUFFER,n.ELEMENT_ARRAY_BUFFER]);return this._buffers[0].data(o.VERTICES,n.STATIC_DRAW),this._buffers[2].data(o.INDICES,n.STATIC_DRAW),i}draw(){const e=this.context.gl;this.context.gl2facade.drawElementsInstanced(e.TRIANGLE_STRIP,o.INDICES.length,e.UNSIGNED_BYTE,0,this._count*this._count)}set count(e){if(this._count===e)return;this._count=e;const t=new Uint8Array(3*e*e),n=r.vec4.create();for(let e=0;e<t.length;e+=3)r.gl_matrix_extensions.encode_uint32_to_rgba8(n,e/3),t[e+0]=n[0],t[e+1]=n[1],t[e+2]=n[2];const i=this.context.gl;this._buffers[1].data(t,i.DYNAMIC_DRAW)}get count(){return this._count}get vertexLocation(){return this._vertexLocation}get instanceLocation(){return this._instanceLocation}}o.VERTICES=new Float32Array([-1,-1,1,1,-1,1,-1,1,1,1,1,1,-1,-1,-1,1,-1,-1,-1,1,-1,1,1,-1]),o.INDICES=new Uint8Array([0,1,2,3,7,1,5,4,7,6,2,4,0,1]),i([a.Initializable.assert_initialized()],o.prototype,"draw",null),t.CubeGeometry=o},526:(e,t,n)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Demo=void 0;const i=n(160);class r extends i.Initializable{showSpinner(){document.getElementsByClassName("spinner").item(0).style.display="inline"}hideSpinner(){document.getElementsByClassName("spinner").item(0).style.display="none"}expose(){window.canvas=this.canvas,window.context=this.canvas.context,window.controller=this.canvas.controller,window.renderer=this.renderer}initialize(e){const t=this.onInitialize(e);return this.renderer.loadingStatus$.subscribe((e=>{e===i.LoadingStatus.Finished?this.hideSpinner():e===i.LoadingStatus.Started&&this.showSpinner()})),this.expose(),t}uninitialize(){this.onUninitialize()}enableFullscreenOnCtrlClick(){const e=this.canvas.element;e.addEventListener("click",(t=>{t.ctrlKey&&i.viewer.Fullscreen.toggle(e)}))}}t.Demo=r},71:e=>{e.exports="\nprecision lowp float;\nprecision lowp int;\n\n\n#if __VERSION__ == 100\n    #define texture(sampler, coord) texture2D(sampler, coord)\n#else \n    #define varying in\n#endif\n\n\n\n#if __VERSION__ == 100\n    #define fragColor gl_FragColor\n#else\n    layout(location = 0) out vec4 fragColor;\n#endif\n\n\nuniform sampler2D u_patches;\nuniform int u_numcubes;\n\nvarying float v_heightAddition;\nvarying vec3 v_cube;\nvarying vec3 v_global;\n\n\nvec2 extract(in vec3 x)\n{\n    return mix(mix(x.xy, x.xz, float(abs(x.y) > 0.999)), x.zy, float(abs(x.x) > 0.999));\n}\n\nvec3 extractNormal(in vec3 x)\n{\n    return mix(mix(\n        vec3(0.0, 0.0, 1.0),\n        vec3(0.0, 1.0, 0.0),\n        float(abs(x.y) > 0.999)\n    ),\n    vec3(1.0, 0.0, 0.0),\n    float(abs(x.x) > 0.999)\n    );\n}\n\n\nvoid main()\n{\n\tvec2 texCoord = extract(v_cube) * 0.5 + 0.5;\n\tfloat cubeHeight = 2.0 / float(u_numcubes);\n\tif(v_cube.y < 0.999)\n\t\ttexCoord.y = mod(v_global.y, cubeHeight) / cubeHeight;\n\ttexCoord.x *= 0.25;\n\n    // compute shadow\n    vec3 light = vec3(-2.0, 3.0, 1.0);\n    vec3 light_ray = normalize(light - v_global);\n    vec3 normal = extractNormal(v_cube);\n    float a = dot(normal, light_ray);\n\n    // compute color\n\tfloat t = (2.0 / 3.0 - v_heightAddition * 2.0) * 1.5 * 4.0 - 1.0;\n\tvec3 c0 = texture(u_patches, texCoord + max(floor(t), 0.0) * vec2(0.25, 0.0)).xyz;\n\tvec3 c1 = texture(u_patches, texCoord + min(floor(t) + 1.0, 3.0) * vec2(0.25, 0.0)).xyz;\n\n\tfragColor = vec4(mix(c0, c1, smoothstep(0.25, 0.75, fract(t))) * pow(a, 0.5), 1.0);\n}\n"},422:e=>{e.exports="precision lowp float;\nprecision lowp int;\n\n\n#if __VERSION__ == 100\n    #define texture(sampler, coord) texture2D(sampler, coord)\n#else\n    #define varying out\n#endif\n\n\n\n#if __VERSION__ == 100\n    attribute vec3 a_vertex;\n    attribute vec3 a_instance;\n#else\n    in vec3 a_vertex;\n\tin vec3 a_instance;\n#endif\n\n\nuniform sampler2D u_terrain;\nuniform mat4 u_viewProjection;\nuniform float u_time;\nuniform int u_numcubes;\n\nvarying float v_heightAddition;\nvarying vec3 v_cube;\nvarying vec3 v_global;\n\n\nvoid main()\n{\n\tfloat oneovernumcubes = 1.0 / float(u_numcubes);\n\tfloat cubeHeight = 2.0 / float(u_numcubes);\n\n\tfloat instanceID = dot(a_instance, vec3(1.0,  256.0, 256.0 * 256.0));\n\n\tvec2 offset = vec2(\n\t\tmod(floor(instanceID), float(u_numcubes)),\n\t\tfloor(floor(instanceID) * oneovernumcubes)) * 2.0 * oneovernumcubes;\n\tvec3 vertex = a_vertex * oneovernumcubes - (1.0 - oneovernumcubes);\n\tvertex.xz += offset;\n\n\tfloat heightAddition = 0.5 * texture(u_terrain, offset * 0.5 + vec2(sin(u_time * 0.04), u_time * 0.02)).r * 2.0 / 3.0;\n\tif(a_vertex.y > 0.0)\n\t    vertex.y += cubeHeight * floor(heightAddition / cubeHeight);\n\n\tv_heightAddition = heightAddition;\n\tv_cube = a_vertex;\n\tv_global = vertex;\n\tgl_Position = u_viewProjection * vec4(vertex, 1.0);\n}\n"},160:t=>{"use strict";t.exports=e}},n={};function i(e){var r=n[e];if(void 0!==r)return r.exports;var a=n[e]={exports:{}};return t[e].call(a.exports,a,a.exports,i),a.exports}var r={};return(()=>{"use strict";var e=r;Object.defineProperty(e,"__esModule",{value:!0}),e.CubescapeDemo=void 0;const t=i(160),n=i(160),a=i(526),o=i(430),s=t.vec3.fromValues(1.5,-.2,1.5),c=t.vec3.fromValues(0,-1,0),u=t.vec3.fromValues(0,1,0);class _ extends n.Renderer{constructor(){super(...arguments),this._numCubes=128}onUpdate(){return this._navigation.update(),this._altered.any||this._camera.altered}onPrepare(){this._altered.canvasSize&&(this._camera.viewport=[this._frameSize[0],this._frameSize[1]],this._camera.aspect=this._canvasSize[0]/this._canvasSize[1]),this._altered.clearColor&&this._defaultFBO.clearColor(this._clearColor),this._geometry.count=this._numCubes,this._altered.reset()}onFrame(e){const t=this._context.gl;this._defaultFBO.bind(),this._defaultFBO.clear(t.DEPTH_BUFFER_BIT,!0,!0),t.viewport(0,0,this._frameSize[0],this._frameSize[1]),t.enable(t.CULL_FACE),t.cullFace(t.BACK),t.enable(t.DEPTH_TEST),this._program.bind(),t.uniformMatrix4fv(this._uViewProjection,!1,this._camera.viewProjection),t.uniform1i(this._program.uniform("u_numcubes"),this._geometry.count),t.uniform1f(this._program.uniform("u_time"),2e-4*window.performance.now()),this._terrain.bind(t.TEXTURE0),this._patches.bind(t.TEXTURE1),t.uniform1i(this._program.uniform("u_terrain"),0),t.uniform1i(this._program.uniform("u_patches"),1),this._geometry.bind(),this._geometry.draw(),this._geometry.unbind(),this._program.unbind(),t.cullFace(t.BACK),t.disable(t.CULL_FACE)}onSwap(){this.invalidate()}onInitialize(e,t,r){const a=this._context.gl;e.enable(["ANGLE_instanced_arrays"]);const _=n.Wizard.queryInternalTextureFormat(this._context,a.RGB,n.Wizard.Precision.byte);this._terrain=new n.Texture2D(this._context),this._terrain.initialize(64,64,_[0],a.RGB,_[1]),this._terrain.wrap(a.REPEAT,a.REPEAT),this._terrain.filter(a.LINEAR,a.LINEAR),this._terrain.fetch("/demos/data/cubescape-terrain.png"),this._patches=new n.Texture2D(this._context),this._patches.initialize(64,16,_[0],a.RGB,_[1]),this._patches.wrap(a.REPEAT,a.REPEAT),this._patches.filter(a.NEAREST,a.NEAREST),this._patches.fetch("/demos/data/cubescape-patches.png"),this._geometry=new o.CubeGeometry(this._context,"cubes"),this._geometry.initialize();const l=new n.Shader(this._context,a.VERTEX_SHADER,"cube.vert");l.initialize(i(422));const h=new n.Shader(this._context,a.FRAGMENT_SHADER,"cube.frag");return h.initialize(i(71)),this._program=new n.Program(this._context),this._program.initialize([l,h],!1),this._program.attribute("a_vertex",this._geometry.vertexLocation),this._program.attribute("a_instances",this._geometry.instanceLocation),this._program.link(),this._uViewProjection=this._program.uniform("u_viewProjection"),void 0===this._camera&&(this._camera=new n.Camera,this._camera.eye=s,this._camera.center=c,this._camera.up=u,this._camera.near=.1,this._camera.far=4),this._navigation=new n.Navigation(t,r),this._navigation.camera=this._camera,this._defaultFBO=new n.DefaultFramebuffer(this._context,"DefaultFBO"),this._defaultFBO.initialize(),!0}onUninitialize(){this._geometry.uninitialize(),this._patches.uninitialize(),this._terrain.uninitialize(),this._defaultFBO.uninitialize()}onDiscarded(){this._altered.alter("canvasSize"),this._altered.alter("clearColor")}}class l extends a.Demo{onInitialize(e){return this._canvas=new n.Canvas(e,{antialias:!0}),this._canvas.controller.multiFrameNumber=1,this._canvas.framePrecision=n.Wizard.Precision.byte,this._canvas.frameScale=[1,1],this._renderer=new _,this._canvas.renderer=this._renderer,!0}onUninitialize(){this._canvas.dispose(),this._renderer.uninitialize()}get canvas(){return this._canvas}get renderer(){return this._renderer}}e.CubescapeDemo=l})(),r})()}));
//# sourceMappingURL=cubescape.js.map